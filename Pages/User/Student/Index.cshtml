@page
@model api.Pages.User.Student.IndexModel
@{
    ViewData["Title"] = "L&T Education - HỆ Thống Học Trực Tuyến";
}

<link rel="stylesheet" href="~/css/site-student.css" asp-append-version="true" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<header>
    <div class="top-bar">
        <div class="container">
            <span class="welcome-text"><i class="fa-regular fa-user"></i> Hi, @Model.StudentName!</span>

            <div class="user-info">
                @if (!string.IsNullOrEmpty(Model.StudentAvatar))
                {
                    <img src="@Model.StudentAvatar" alt="Avatar" class="avatar-img" />
                }
                else
                {
                    <div class="user-avatar">@(Model.StudentName?.Length > 1 ? Model.StudentName.Substring(0, 2).ToUpper() : "SD")</div>
                }
                <a href="#">ĐĂNG NHẬP BẰNG TÀI KHOẢN CỦA BẠN</a>
                <a href="#">Student</a>
                <a href="#">Professor</a>
                <a href="#">PD</a>
            </div>
        </div>
    </div>

    <nav class="header-nav">
        <div class="container">
            <div class="logo">
                <a href="/">
                    <img src="https://via.placeholder.com/150x40/dc3545/FFFFFF?text=L%26T+EDU" alt="L&T Education Logo">
                    <span>HỆ THỐNG HỌC TRỰC TUYẾN</span>
                </a>
            </div>
            <div class="header-controls">
                <a href="#" class="lang-select"><i class="fas fa-globe"></i>Vietnamese (VI)</a>
                <a href="#"><i class="fas fa-bell"></i></a> <a href="#"><i class="fas fa-cog"></i></a> </div>
        </div>
    </nav>

    <section class="banner">
        <div class="container">
            <div class="banner-main-content">
                <h1>HUFLIT 2025<br>TUYỂN SINH THẠC SĨ</h1>
                <p>Chào mừng bạn đến với hệ thống học tập trực tuyến của L&T Education!</p>
                <div class="banner-info-boxes">
                    <div class="banner-info-box">
                        <strong>1.000+</strong>
                        <span>Học viên đã tốt nghiệp</span>
                    </div>
                    <div class="banner-info-box">
                        <strong>50+</strong>
                        <span>Khóa học đa dạng</span>
                    </div>
                    <div class="banner-info-box">
                        <strong>10+</strong>
                        <span>Năm kinh nghiệm</span>
                    </div>
                </div>
            </div>
            <div class="banner-right-panel">
                <h3>CÔNG NGHỆ THÔNG TIN</h3>
                <p>Sẵn sàng cho một tương lai đầy hứa hẹn?</p>
                <div class="input-group">
                    <input type="text" placeholder="Nhập mã kích hoạt khóa học...">
                    <button type="submit">Kích hoạt</button>
                </div>
                <div class="links">
                    <a href="#">Đăng nhập</a>
                    <a href="#">Xem thời khóa biểu</a>
                    <a href="#">Tìm kiếm lớp học</a>
                </div>
            </div>
        </div>
    </section>
</header>

<main class="main-content">
    <div class="container">
        <section class="icon-boxes-small">
            <a href="#" class="icon-box-small">
                <i class="fas fa-home"></i>
                <p>Trang chủ</p>
            </a>
            <a href="#" class="icon-box-small">
                <i class="fas fa-bell"></i>
                <p>Thông báo</p>
            </a>
            <a href="#" class="icon-box-small">
                <i class="fas fa-calendar-alt"></i>
                <p>Thời khóa biểu</p>
            </a>
            <a href="#" class="icon-box-small">
                <i class="fas fa-book-open"></i>
                <p>Đăng ký học phần</p>
            </a>
            <a href="#" class="icon-box-small">
                <i class="fas fa-chart-line"></i>
                <p>Tra cứu điểm</p>
            </a>
            <a href="#" class="icon-box-small">
                <i class="fas fa-dollar-sign"></i>
                <p>Thanh toán học phí</p>
            </a>
            <a href="#" class="icon-box-small">
                <i class="fas fa-lightbulb"></i>
                <p>Đăng ký đề tài</p>
            </a>
            <a href="#" class="icon-box-small">
                <i class="fas fa-envelope"></i>
                <p>Liên hệ</p>
            </a>
        </section>

        <section class="card-section">
            <div class="section-header">
                <h2>Thời gian biểu cá nhân</h2>
                <a href="#" class="view-all">Xem chi tiết</a>
            </div>
            <div class="notification-list">
                <ul>
                    @if (Model.Exams != null && Model.Exams.Any())
                    {
                        foreach (var exam in Model.Exams.OrderBy(e => e.ExamDate).Take(3))
                        {
                            <li>
                                <div class="date">
                                    <span>@exam.ExamDate.Day</span>Tháng @exam.ExamDate.Month
                                </div>
                                <div class="content">
                                    <strong>[Lịch thi] @exam.Title</strong>
                                    <p>Bắt đầu: @exam.StartTime.ToString("HH:mm dd/MM/yyyy")</p>
                                    <p>Kết thúc: @exam.EndTime.ToString("HH:mm dd/MM/yyyy")</p>
                                </div>
                                <div class="actions">
                                    <a href="#">Chi tiết</a>
                                </div>
                            </li>
                        }
                    }
                    else
                    {
                        <li>
                            <div class="content">Không có lịch thi nào sắp tới.</div>
                        </li>
                    }
                </ul>
            </div>
        </section>

        <section class="feature-cards">
            <a href="#" class="feature-card">
                <div class="icon"><i class="fas fa-history"></i></div>
                <div class="content">
                    <h4>Lịch sử học tập</h4>
                    <p>Xem lại quá trình học tập, các môn đã học, điểm số và kết quả.</p>
                    <span class="view-more">Xem chi tiết</span>
                </div>
            </a>
            <a href="#" class="feature-card">
                <div class="icon"><i class="fas fa-bullhorn"></i></div>
                <div class="content">
                    <h4>Thông báo chung</h4>
                    <p>Cập nhật những thông tin, tin tức mới nhất từ L&T Education.</p>
                    <span class="view-more">Xem chi tiết</span>
                </div>
            </a>
            <a href="#" class="feature-card">
                <div class="icon"><i class="fas fa-calendar-check"></i></div>
                <div class="content">
                    <h4>Thời khóa biểu cá nhân</h4>
                    <p>Xem thời gian biểu các lớp học, phòng học, giáo viên chi tiết.</p>
                    <span class="view-more">Xem chi tiết</span>
                </div>
            </a>
            <a href="#" class="feature-card">
                <div class="icon"><i class="fas fa-file-invoice"></i></div>
                <div class="content">
                    <h4>Đăng ký học phần</h4>
                    <p>Thực hiện đăng ký các học phần cho kỳ học tiếp theo.</p>
                    <span class="view-more">Xem chi tiết</span>
                </div>
            </a>
             <a href="#" class="feature-card">
                <div class="icon"><i class="fas fa-poll"></i></div>
                <div class="content">
                    <h4>Tra cứu điểm</h4>
                    <p>Xem kết quả điểm thi các môn học và điểm trung bình tích lũy.</p>
                    <span class="view-more">Xem chi tiết</span>
                </div>
            </a>
             <a href="#" class="feature-card">
                <div class="icon"><i class="fas fa-receipt"></i></div>
                <div class="content">
                    <h4>Thanh toán học phí</h4>
                    <p>Quản lý các khoản học phí, lịch sử thanh toán và tình trạng công nợ.</p>
                    <span class="view-more">Xem chi tiết</span>
                </div>
            </a>
        </section>

        <section class="card-section">
            <div class="section-header">
                <h2>Đào tạo</h2>
                <a href="#" class="view-all">Xem tất cả</a>
            </div>
            <div class="colorful-grid">
                <a href="#" class="grid-item-colored blue span-2-col tall top-left-content">
                    <h4>Chương trình đào tạo</h4>
                    <p>Thông tin chi tiết về các ngành đào tạo và chương trình học.</p>
                </a>
                <a href="#" class="grid-item-colored pink">
                    <i class="fas fa-user-graduate"></i>
                    <h4>Tuyển sinh</h4>
                </a>
                <a href="#" class="grid-item-colored purple">
                    <i class="fas fa-users"></i>
                    <h4>Sinh viên</h4>
                </a>
                <a href="#" class="grid-item-colored orange">
                    <i class="fas fa-briefcase"></i>
                    <h4>Việc làm</h4>
                </a>
                <a href="#" class="grid-item-colored green">
                    <i class="fas fa-globe"></i>
                    <h4>Quốc tế</h4>
                </a>
                <a href="#" class="grid-item-colored teal">
                    <i class="fas fa-laptop-code"></i>
                    <h4>Công nghệ</h4>
                </a>
                <a href="#" class="grid-item-colored cyan">
                    <i class="fas fa-book"></i>
                    <h4>Thư viện</h4>
                </a>
                <a href="#" class="grid-item-colored red">
                    <i class="fas fa-university"></i>
                    <h4>Khoa học</h4>
                </a>
            </div>
        </section>

        <section class="card-section">
            <div class="section-header">
                <h2>Hoạt động học tập</h2>
                <a href="#" class="view-all">Xem tất cả</a>
            </div>
            <div class="colorful-grid">
                <a href="#" class="grid-item-colored blue">
                    <i class="fas fa-graduation-cap"></i>
                    <h4>Đề án tốt nghiệp</h4>
                </a>
                <a href="#" class="grid-item-colored pink">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <h4>Giảng viên</h4>
                </a>
                <a href="#" class="grid-item-colored purple">
                    <i class="fas fa-puzzle-piece"></i>
                    <h4>Câu lạc bộ</h4>
                </a>
                <a href="#" class="grid-item-colored orange">
                    <i class="fas fa-medal"></i>
                    <h4>Thành tích</h4>
                </a>
            </div>
        </section>

        <section class="calendar-section">
            <div class="calendar-view">
                <div class="calendar-header">
                    <button>&lt;</button>
                    <h3>Tháng @DateTime.Now.Month, @DateTime.Now.Year</h3>
                    <button>&gt;</button>
                </div>
                <div class="days-of-week">
                    <span>CN</span><span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span>
                </div>
                <div class="calendar-grid">
                    @* Logic để hiển thị các ngày trong tháng *@
                    @{
                        var today = DateTime.Today;
                        var firstDayOfMonth = new DateTime(today.Year, today.Month, 1);
                        var daysInMonth = DateTime.DaysInMonth(today.Year, today.Month);
                        var startDayOfWeek = (int)firstDayOfMonth.DayOfWeek; // 0 for Sunday, 1 for Monday...

                        // Fill empty cells for days before the 1st
                        for (int i = 0; i < startDayOfWeek; i++)
                        {
                            <span class="calendar-day empty"></span>
                        }

                        // Fill days of the month
                        for (int day = 1; day <= daysInMonth; day++)
                        {
                            var currentDay = new DateTime(today.Year, today.Month, day);
                            var isCurrentDay = currentDay.Date == today.Date ? "current-day" : "";
                            var isEventDay = Model.Exams.Any(e => e.ExamDate.Date == currentDay.Date) ? "event-day" : "";

                            <span class="calendar-day @isCurrentDay @isEventDay">@day</span>
                        }
                    }
                </div>
            </div>
            <div class="event-list">
                <h3>Sự kiện sắp tới</h3>
                <ul>
                    @if (Model.Exams != null && Model.Exams.Any())
                    {
                        foreach (var exam in Model.Exams.OrderBy(e => e.StartTime).Take(3))
                        {
                            <li>
                                <div class="event-time">@exam.StartTime.ToString("dd/MM/yyyy - HH:mm")</div>
                                <div class="event-title">Lịch thi: @exam.Title</div>
                            </li>
                        }
                    }
                    else
                    {
                        <li>
                            <div class="event-title">Không có sự kiện nào sắp tới.</div>
                        </li>
                    }
                </ul>
            </div>
        </section>
<section class="card-section">
    <p>DEBUG: StudentClassId = @Model.StudentClassId</p>
    <div class="section-header">
        <h2>Lịch học của tôi</h2>
        <a href="#" class="view-all">Xem toàn bộ</a>
    </div>
    <div class="table-section">
        <div class="week-selector-container">
            <label for="weekSelector">Chọn tuần:</label>
            <select id="weekSelector" class="form-control">
                </select>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Môn học</th>
                    <th>Thứ</th>
                    <th>Ngày học</th>
                    <th>Giờ bắt đầu</th>
                    <th>Giờ kết thúc</th>
                    <th>Phòng học</th>
                    <th>Giảng viên</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="scheduleTableBody">
                </tbody>
        </table>
    </div>
</section>


        <section class="card-section">
            <div class="section-header">
                <h2>Tiện ích khác</h2>
                <a href="#" class="view-all">Xem thêm</a>
            </div>
            <div class="colorful-grid">
                <a href="#" class="grid-item-colored blue">
                    <i class="fas fa-map"></i>
                    <h4>Sơ đồ trường</h4>
                </a>
                <a href="#" class="grid-item-colored pink">
                    <i class="fas fa-dollar-sign"></i>
                    <h4>Học phí</h4>
                </a>
                <a href="#" class="grid-item-colored purple">
                    <i class="fas fa-question-circle"></i>
                    <h4>Hỗ trợ</h4>
                </a>
                <a href="#" class="grid-item-colored orange">
                    <i class="fas fa-file-alt"></i>
                    <h4>Văn bản</h4>
                </a>
            </div>
        </section>
    </div>
</main>

<footer class="footer">
    <div class="container">
        <p>© 2025 L&T Education. All rights reserved. | <a href="#" style="color: white;">Chính sách bảo mật</a></p>
    </div>
</footer>

@section Scripts {
<script>
    let allClassScheduleData = [];
    const classIdForSchedule = parseInt("@Model.StudentClassId");

    function formatDate(date) {
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
    }

    function mapDayOfWeekToVietnamese(day) {
        const map = {
            "Monday": "Thứ 2",
            "Tuesday": "Thứ 3",
            "Wednesday": "Thứ 4",
            "Thursday": "Thứ 5",
            "Friday": "Thứ 6",
            "Saturday": "Thứ 7",
            "Sunday": "Chủ Nhật"
        };
        return map[day] || day;
    }

    function renderSchedule(scheduleData) {
        const tableBody = document.getElementById("scheduleTableBody");
        tableBody.innerHTML = "";

        if (!scheduleData || scheduleData.length === 0) {
            const row = tableBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 8;
            cell.textContent = "Không có lịch học nào trong tuần này.";
            cell.style.textAlign = "center";
            return;
        }

        for (const item of scheduleData) {
            const row = tableBody.insertRow();
            row.insertCell().textContent = item.courseName || "N/A";
            row.insertCell().textContent = mapDayOfWeekToVietnamese(item.dayOfWeek);
            row.insertCell().textContent = formatDate(item.date);
            row.insertCell().textContent = item.startTime;
            row.insertCell().textContent = item.endTime;
            row.insertCell().textContent = item.room || "N/A";
            row.insertCell().textContent = item.teacherName || "N/A";

            const actionCell = row.insertCell();
            const detailLink = document.createElement("a");
            detailLink.href = "#";
            detailLink.textContent = "Chi tiết";
            actionCell.appendChild(detailLink);
            actionCell.classList.add("action-links");
        }
    }

    function getCurrentWeekStart() {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - (day === 0 ? 6 : day - 1);
        const monday = new Date(today.setDate(diff));
        monday.setHours(0, 0, 0, 0);
        return monday;
    }

    function populateWeekSelector() {
        const weekSelector = document.getElementById("weekSelector");
        weekSelector.innerHTML = "";

        const base = getCurrentWeekStart();
        const weeks = [];

        for (let i = -4; i <= 4; i++) {
            const start = new Date(base);
            start.setDate(start.getDate() + i * 7);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);

            const label = `Tuần ${formatDate(start)} - ${formatDate(end)}`;
            const option = document.createElement("option");
            option.value = start.toISOString().split("T")[0];
            option.textContent = label;

            if (i === 0) option.selected = true;

            weekSelector.appendChild(option);
        }

        return weekSelector.value;
    }

    function displayScheduleForWeek(weekStartDateStr) {
        const weekStart = new Date(weekStartDateStr);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);

        const filtered = allClassScheduleData.filter(item => {
            const d = new Date(item.date);
            return d >= weekStart && d <= weekEnd;
        });

        renderSchedule(filtered);
    }

    document.addEventListener("DOMContentLoaded", async () => {
        if (!classIdForSchedule || isNaN(classIdForSchedule)) {
            console.error("Lỗi: classIdForSchedule không hợp lệ.");
            return;
        }

        try {
            // Get class
            const classRes = await fetch(`https://api-ielts-cgn8.onrender.com/api/Class/${classIdForSchedule}`);
            const classData = await classRes.json();

            const courseId = classData.courseId || 0;
            const teacherId = classData.teacherId || 0;
            const roomName = classData.room || classData.name || "Phòng học";

            // Get course
            let courseName = "Môn học";
            if (courseId) {
                const courseRes = await fetch(`https://api-ielts-cgn8.onrender.com/api/Course/${courseId}`);
                if (courseRes.ok) {
                    const course = await courseRes.json();
                    courseName = course.name;
                }
            }

            // Get teacher
            let teacherName = "Giảng viên";
            if (teacherId) {
                const teacherRes = await fetch(`https://api-ielts-cgn8.onrender.com/api/Teacher/${teacherId}`);
                if (teacherRes.ok) {
                    const teacher = await teacherRes.json();
                    teacherName = teacher.name;
                }
            }

            // Get schedule
            const scheduleRes = await fetch(`https://api-ielts-cgn8.onrender.com/api/Class/${classIdForSchedule}/studydays`);
            const rawSchedule = await scheduleRes.json();

            // Fake date for recurring schedule: Convert dayOfWeek to next date
            const today = new Date();
            allClassScheduleData = rawSchedule.map(s => {
                const dow = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                const targetDow = dow.indexOf(s.dayOfWeek);
                const currentDow = today.getDay();
                const offset = (targetDow + 7 - currentDow) % 7;
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + offset);

                return {
                    courseName,
                    dayOfWeek: s.dayOfWeek,
                    date: targetDate,
                    startTime: s.startTime,
                    endTime: s.endTime,
                    room: roomName,
                    teacherName
                };
            });

            const defaultWeek = populateWeekSelector();
            displayScheduleForWeek(defaultWeek);

            document.getElementById("weekSelector").addEventListener("change", e => {
                displayScheduleForWeek(e.target.value);
            });

        } catch (err) {
            console.error("Lỗi khi tải dữ liệu lịch học:", err);
        }
    });
</script>

}